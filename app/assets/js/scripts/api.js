const https=require("https"),path=require("path"),fs=require("fs"),rootPath=require("electron-root-path").rootPath,log=require("./logger.js"),{Client}=require("tdl"),{TDLib}=require("tdl-tdlib-ffi");var[counterProxy,balance,codeGlobal,activateGlobal,selectProxy,numberProxy]=[1,!0,!1,!0,void 0,0];function errorReturn(){switch([counterProxy,balance,codeGlobal,activateGlobal,selectProxy,numberProxy]=[1,!0,!1,!0,void 0,0],localStorage.getItem("page")){case"1":button=document.getElementById("startParse"),button.style.background="",button.innerText="\u041D\u0430\u0447\u0430\u0442\u044C",button.setAttribute("disambled",!1);break;case"2":button=document.getElementById("page2startParse"),button.style.background="",button.innerText="\u0414\u043E\u0431\u0430\u0432\u0438\u0442\u044C",button.setAttribute("disambled",!1);break;case"3":button=document.getElementById("page3startParse"),button.style.background="",button.innerText="\u041F\u043E\u043B\u0443\u0447\u0438\u0442\u044C \u043A\u043E\u0434",button.setAttribute("disambled",!1);}return!1}function clientInner(a){return new Client(new TDLib("tdjson"),{apiId:1770587,apiHash:"44e63611c5fc3669c527492b61b76c46",useFileDatabase:!1,useChatInfoDatabase:!1,useMessageDatabase:!1,useSecretChats:!1,systemLanguageCode:"en",deviceModel:"NoModel1",systemVersion:"0.0.2",applicationVersion:"0.0.2",enableStorageOptimizer:!0,ignoreFileNames:!1,filesDirectory:path.join(a,"_td_files"),databaseDirectory:path.join(a,"_td_database")})}async function generator(a,b){if(localStorage.setItem("code",!1),balance){async function c(c,d){d+="",activateGlobal=!0,codeGlobal=!1;let e=path.join(rootPath,"account",d);fs.existsSync(path.join(rootPath,"account"))||fs.mkdirSync(path.join(rootPath,"account")),fs.existsSync(path.join(rootPath,"account",d))||fs.mkdirSync(path.join(rootPath,"account",d)),(()=>{let a=path.join(rootPath,"numberProxy.log");fs.existsSync(a)?fs.appendFileSync(a,`${d}:${selectProxy.ip}:${selectProxy.port}\r\n`):(fs.writeFileSync(a,""),fs.appendFileSync(a,`${d}:${selectProxy.ip}:${selectProxy.port}\r\n`))})();let f=clientInner(e);await f.connect(),await f.invoke({_:"addProxy",server:selectProxy.ip,port:selectProxy.port,enable:!0,type:{_:"proxyTypeSocks5",secret:"15abcdef1234567890deadbeef123456"}}),intervalFind=setInterval(()=>{https.get(`${b.href}?api_key=${a.api}&action=setStatus&status=1&id=${c}`,e=>{new String;e.on("data",a=>{}),e.on("end",()=>{https.get(`${b.href}?api_key=${a.api}&action=getStatus&id=${c}`,a=>{let b=new String;a.on("data",a=>{b+=a}),a.on("end",()=>{var a=b.split(":");switch(a[0]){case"STATUS_WAIT_CODE":console.log("waiting...");break;case"STATUS_OK":clearInterval(intervalFind),"false"==localStorage.getItem("code")&&(localStorage.setItem("code",a[1]),log.ok("sms-activate",`Get code code: ${a[1]}`));break;case"STATUS_WAIT_RESEND":console.log("STATUS_WAIT_RESEND");break;default:log.warn("sms-activate",`We expected a code from the site for the number ${d} and got an error ${a[0]}`);}})})})})},100),await f.login(()=>({type:"user",getPhoneNumber:()=>d,getAuthCode:async a=>a?void console.log("Code","Invalid auth code..."):new Promise(a=>intervalFindPassword=setInterval(()=>{let b=localStorage.getItem("code");"false"!=b&&(clearInterval(intervalFindPassword),localStorage.setItem("code",!1),a(b))},100)),getName:()=>{let b=a.name[Math.floor(Math.random()*a.name.length)];return log.warn("sms-activate",`Set name: ${b}`),{firstName:b,lastName:""}}}));let g=a.avatarPath[Math.floor(Math.random()*a.avatarPath.length)],h=path.join(document.getElementById("final-user-avatar").value,g);console.log(h),fs.existsSync(h)||(h=path.join(rootPath,"app","assets","css","avatar.jpg")),await f.invoke({"@type":"setProfilePhoto",photo:{"@type":"inputFileLocal",path:h}}),errorReturn();let i=document.getElementById("intervalAvtomatic").value;setTimeout(()=>{log.ok("Telegram",`Create Account`),counterProxy++,generator(a,b)},i?1e3*i:3e3)}if(5<=counterProxy||!selectProxy){if(numberProxy==a.proxy.length)return log.error("Proxy",`Proxy is no valid OR using all`),counterProxy=1,[selectProxy,numberProxy]=[void 0,0],errorReturn(),!1;selectProxy&&(counterProxy=0),selectProxy=a.proxy[numberProxy],numberProxy++,log.warn("Proxy",`Use proxy: ${selectProxy.ip}:${selectProxy.port}`)}https.get(`${b.href}?api_key=${a.api}&action=getNumber&service=tg&country=0`,d=>{let e=new String;d.on("data",a=>{e+=a}),d.on("end",()=>{let d=e.split(":");d[1]&&d[2]?(log.ok("sms-activate",`Get id and numer: ${d[1]} ${d[2]}`),c(d[1],d[2])):"NO_NUMBERS"==e?(log.warn("sms-activate",`The numbers on the site are out.I'll try to request again`),setTimeout(function(){generator(a,b)},8e3)):"NO_BALANCE"==e?(log.error("sms-activate",`You are out of balance. After replenishment, restart`),balance=!1,errorReturn()):(log.error("sms-activate",`Server return error: ${e}`),balance=!1,errorReturn())})})}else log.error("sms-activate",`Insufficient funds`),errorReturn()}function startParser(a,b,c){c>=b.balans?https.get(`${b.href}?api_key=${a.api}&action=getNumbersStatus&country=0`,d=>{let e=new String;d.on("data",a=>{e+=a}),d.on("end",()=>{log.warn("sms-activate",`balans: ${c}, min balans: ${b.balans}, total available number: ${JSON.parse(e).tg_0}`),generator(a,b)})}):(log.error("sms-activate",`balans: ${c}, min balans: ${b.balans}`),errorReturn())}async function oneAdd(a){log.warn("Script",`Start create...`);let b=path.join(rootPath,"account",a.number);if(fs.existsSync(path.join(rootPath,"account"))||fs.mkdirSync(path.join(rootPath,"account")),!fs.existsSync(path.join(rootPath,"account",a.number)))fs.mkdirSync(path.join(rootPath,"account",a.number)),log.ok("Script",`Create folder database`);else try{fs.rmdirSync(path.join(rootPath,"account",a.number)),fs.mkdirSync(path.join(rootPath,"account",a.number)),log.ok("Script",`Number exist, i removing and new create`)}catch{}(()=>{let b=path.join(rootPath,"numberProxy.log");fs.existsSync(b)?fs.appendFileSync(b,`${a.number}:${a.proxy[0].ip}:${a.proxy[0].port}\r\n`):(fs.writeFileSync(b,""),fs.appendFileSync(b,`${a.number}:${a.proxy[0].ip}:${a.proxy[0].port}\r\n`))})();let c=clientInner(b);await c.connect();try{await c.invoke({_:"addProxy",server:a.proxy[0].ip,port:a.proxy[0].port,enable:!0,type:{_:"proxyTypeSocks5",secret:"15abcdef1234567890deadbeef123456"}})}catch{log.ok("Script",`Proxy no correct`),errorReturn()}await c.login(()=>({type:"user",getPhoneNumber:()=>(document.getElementById("page3type1").style.display="none",document.getElementById("page3type2").style.display="block",a.number),getAuthCode:async a=>a?void console.log("Code","Invalid auth code..."):new Promise(a=>intervalFindPassword=setInterval(()=>{let b=localStorage.getItem("code2");"false"!=b&&(clearInterval(intervalFindPassword),localStorage.setItem("code2",!1),a(b))},100)),getName:()=>({firstName:a.name,lastName:""})})),await c.invoke({"@type":"setProfilePhoto",photo:{"@type":"inputFileLocal",path:a.avatar?a.avatar:path.join(rootPath,"app","assets","css","avatar.jpg")}}),document.getElementById("page3type1").style.display="block",document.getElementById("page3type2").style.display="none",errorReturn()}async function getCode(a){let b=setTimeout(()=>{log.warn("Error",`The script took too long (15 seconds) to execute, an error may have occurred, please try again`),errorReturn()},15e3),c=path.join(rootPath,"account",a.number);if(fs.existsSync(c)){let d=clientInner(c);await d.connect(),await d.invoke({_:"addProxy",server:a.proxy[0].ip,port:a.proxy[0].port,enable:!0,type:{_:"proxyTypeSocks5",secret:"15abcdef1234567890deadbeef123456"}});let e=await d.invoke({_:"getChatHistory",chat_id:"777000",lastID:0,limit:1});document.getElementById("page3CodeMessage").value=e.messages[0].content.text.text,clearTimeout(b),errorReturn()}else log.error("Get Account Auth",`I cant find this number`),errorReturn();(()=>{let a=path.join(rootPath,"account");if(fs.existsSync(a)){let b=fs.readdirSync(a).filter(b=>fs.statSync(path.join(a,b)).isDirectory());for(local in b)log.warn("GetAccount",`Available: ${b[local]}`)}else log.warn("GetAccount",`Account is no exist`)})()}module.exports.startParser=startParser,module.exports.oneAdd=oneAdd,module.exports.getCode=getCode;
